# Fire å®¹å™¨è¿è¡Œæ—¶

Fire æ˜¯ä¸€ä¸ªåŸºäº Rust å®ç°çš„ OCI å…¼å®¹å®¹å™¨è¿è¡Œæ—¶ï¼Œæ”¯æŒå®Œæ•´çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âš ï¸ **OCI å…¼å®¹ï¼ˆéƒ¨åˆ†ï¼‰**ï¼šå·²å®ç° Spec è§£æä¸ cgroup èµ„æºé™åˆ¶ï¼›mount ä¸ namespace æ­£åœ¨å¼€å‘
- âœ… **å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šæ”¯æŒ create / start / run / kill / delete / state ç­‰å‘½ä»¤
- âœ… **cgroups èµ„æºé™åˆ¶**ï¼šå®ç° cpuã€memoryã€blkioã€pids ç­‰æ§åˆ¶å™¨
- ğŸš§ **Namespace éš”ç¦»**ï¼šæ¥å£å·²é¢„ç•™ï¼ŒåŠŸèƒ½å¼€å‘ä¸­
- ğŸš§ **Rootfs æŒ‚è½½ä¸ pivot_root**ï¼šåŸºç¡€æ¡†æ¶å®Œæˆï¼ŒæŒ‚è½½ä¸åˆ‡æ ¹å°šåœ¨å®Œå–„
- âœ… **æ¨¡å—åŒ–æ¶æ„ & ä¸­æ–‡æ—¥å¿—**ï¼šRust 2021ï¼Œé”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—å‹å¥½

## å®‰è£…æ„å»º

### å‰ç½®è¦æ±‚

- Rust 1.70.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- Linux å†…æ ¸ï¼ˆéœ€å¯ç”¨ cgroupsã€namespacesï¼‰
- å…·æœ‰ **root æƒé™**ï¼ˆæŒ‚è½½ã€cgroup å†™å…¥ç­‰æ“ä½œéœ€è¦ï¼‰

### æ„å»º

```bash
git clone https://github.com/wu-eee/fire
cd fire
cargo build --release
```

### å®‰è£…

```bash
cargo install --path .
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬å‘½ä»¤

```bash
# æŸ¥çœ‹å¸®åŠ©
fire --help

# åˆ—å‡ºæ‰€æœ‰å®¹å™¨
fire ps

# åˆ›å»ºå®¹å™¨
fire create <container-id> [bundle-path]

# å¯åŠ¨å®¹å™¨
fire start <container-id>

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
fire state <container-id>

# å‘å®¹å™¨å‘é€ä¿¡å·
fire kill <container-id> [--signal <signal>]

# åˆ é™¤å®¹å™¨
fire delete <container-id> [--force]

# ä¸€é”®è¿è¡Œå®¹å™¨ï¼ˆåˆ›å»º+å¯åŠ¨ï¼‰
fire run <container-id> [bundle-path]
```

### ç¤ºä¾‹

```bash
# åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæµ‹è¯•å®¹å™¨
fire create mycontainer /path/to/bundle
fire start mycontainer

# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
fire state mycontainer

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
fire kill mycontainer
fire delete mycontainer

# æˆ–è€…ä¸€é”®è¿è¡Œ
fire run mycontainer /path/to/bundle
```

## é…ç½®æ–‡ä»¶

Fire ä½¿ç”¨æ ‡å‡†çš„ OCI é…ç½®æ–‡ä»¶æ ¼å¼ (`config.json`)ã€‚ç¤ºä¾‹é…ç½®æ–‡ä»¶ï¼š

```json
{
  "ociVersion": "1.0.0",
  "process": {
    "terminal": false,
    "user": {
      "uid": 0,
      "gid": 0
    },
    "args": ["/bin/sh", "-c", "echo 'Hello from Fire!'"],
    "env": [
      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
      "TERM=xterm"
    ],
    "cwd": "/"
  },
  "root": {
    "path": "rootfs",
    "readonly": true
  },
  "hostname": "fire-container",
  "linux": {
    "namespaces": [
      {"type": "pid"},
      {"type": "network"},
      {"type": "ipc"},
      {"type": "uts"},
      {"type": "mount"}
    ]
  }
}
```

## ç›®å½•ç»“æ„

```
fire/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ commands/          # å‘½ä»¤å®ç°
â”‚   â”‚   â”œâ”€â”€ create.rs      # åˆ›å»ºå®¹å™¨
â”‚   â”‚   â”œâ”€â”€ start.rs       # å¯åŠ¨å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ kill.rs        # ç»ˆæ­¢å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ delete.rs      # åˆ é™¤å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ state.rs       # çŠ¶æ€æŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ run.rs         # è¿è¡Œå®¹å™¨
â”‚   â”‚   â””â”€â”€ ps.rs          # åˆ—å‡ºå®¹å™¨
â”‚   â”œâ”€â”€ container/         # å®¹å™¨ç®¡ç†
â”‚   â”œâ”€â”€ runtime/           # è¿è¡Œæ—¶ç®¡ç†
â”‚   â”œâ”€â”€ errors.rs          # é”™è¯¯å¤„ç†
â”‚   â””â”€â”€ main.rs            # ä¸»ç¨‹åº
â”œâ”€â”€ oci/                   # OCI è§„èŒƒå®ç°
â””â”€â”€ target/                # æ„å»ºè¾“å‡º
```

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **å‘½ä»¤å±‚**ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œå®ç°å„ç§å®¹å™¨æ“ä½œå‘½ä»¤
2. **è¿è¡Œæ—¶å±‚**ï¼šç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œç»´æŠ¤å®¹å™¨çŠ¶æ€
3. **å®¹å™¨å±‚**ï¼šå°è£…å®¹å™¨ç›¸å…³æ“ä½œå’ŒçŠ¶æ€ç®¡ç†
4. **OCI å±‚**ï¼šå®ç° OCI è§„èŒƒçš„æ•°æ®ç»“æ„å’Œåºåˆ—åŒ–

### å…³é”®ç‰¹æ€§

- **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Rust çš„ç±»å‹ç³»ç»Ÿä¿è¯å†…å­˜å®‰å…¨
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œæ”¯æŒä¸åŒçº§åˆ«çš„æ—¥å¿—è¾“å‡º
- **æ¨¡å—åŒ–**ï¼šæ¸…æ™°çš„æ¨¡å—è¾¹ç•Œï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

## çŠ¶æ€ç®¡ç†

å®¹å™¨çŠ¶æ€å­˜å‚¨åœ¨ `~/.fire/<container-id>/state.json` æ–‡ä»¶ä¸­ï¼ŒåŒ…å«ï¼š

- å®¹å™¨ ID
- å½“å‰çŠ¶æ€ï¼ˆcreated/running/stoppedï¼‰
- è¿›ç¨‹ PID
- Bundle è·¯å¾„
- æ³¨è§£ä¿¡æ¯

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°å‘½ä»¤

1. åœ¨ `src/commands/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„å‘½ä»¤æ–‡ä»¶
2. å®ç° `Command` trait
3. åœ¨ `src/commands/mod.rs` ä¸­æ³¨å†Œæ–°å‘½ä»¤
4. åœ¨ `src/main.rs` ä¸­æ·»åŠ å‘½ä»¤è¡Œå‚æ•°è§£æ

### æ‰©å±•åŠŸèƒ½

- **ç½‘ç»œç®¡ç†**ï¼šå®ç°ç½‘ç»œå‘½åç©ºé—´å’Œç½‘ç»œé…ç½®
- **å­˜å‚¨ç®¡ç†**ï¼šæ”¯æŒæ›´å¤šçš„å­˜å‚¨é©±åŠ¨å’ŒæŒ‚è½½é€‰é¡¹
- **å®‰å…¨åŠŸèƒ½**ï¼šå¢å¼º SELinuxã€AppArmor å’Œ seccomp æ”¯æŒ
- **ç›‘æ§é›†æˆ**ï¼šæ·»åŠ  Prometheus æŒ‡æ ‡å’Œå¥åº·æ£€æŸ¥

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æƒé™é”™è¯¯**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„æƒé™åˆ›å»ºç›®å½•å’Œæ–‡ä»¶
2. **é…ç½®é”™è¯¯**ï¼šæ£€æŸ¥ `config.json` æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
3. **è·¯å¾„é—®é¢˜**ï¼šç¡®ä¿ bundle è·¯å¾„å’Œ rootfs è·¯å¾„å­˜åœ¨

### æ—¥å¿—è°ƒè¯•

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
RUST_LOG=debug fire <command>

# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
fire <command> 2>&1 | grep ERROR
```

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ GNU General Public License v2.0 è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## è‡´è°¢

- [OCI è¿è¡Œæ—¶è§„èŒƒ](https://github.com/opencontainers/runtime-spec)
- [Rust ç¼–ç¨‹è¯­è¨€](https://rust-lang.org/)
- [clap å‘½ä»¤è¡Œè§£æåº“](https://docs.rs/clap/)
- [serde åºåˆ—åŒ–åº“](https://serde.rs/)
